z$Azythro.Clarithro.discharge.only[is.na(z$Azythro.Clarithro.discharge.only)]<-0
z$DOT.Azythro.Clarithro.discharge.only<-ifelse(z$Azythro.Clarithro.discharge.only==1 & z$DOT.azy.clarith.dc!=0,z$DOT.azy.clarith.dc,0)
# Chunk 101
# Patients treated only with amox/penicillin/ampicillin TOTAL (Y/N)
z$amox.amp.pen.only.yn.total <-ifelse(z$amox.amp.pen.only.yn.hospital.r ==1|z$amox.amp.pen.only.yn.discharge.r==1, 1,0)
z$amox.amp.pen.only.yn.total[is.na(z$amox.amp.pen.only.yn.total)]<-0
#DOT: TOTAL
z$DOT.amox.amp.pen.only.total <-ifelse(z$amox.amp.pen.only.yn.total==1,z$DOT.Amox.Ampic.Penicil,0 )
# Chunk 102
z$date_x_ray_with_effusion<-ymd(z$date_x_ray_with_effusion)
# z$date.illness.effusion<-z$date_ed-z$date_x_ray_with_effusion
# Chunk 103
z$bl.positive <-NA
z$bl.positive[z$bl_cul_isolate_name==""|
z$bl_cul_isolate_name=="Negative"|
z$bl_cul_isolate_name=="negative"|
z$bl_cul_isolate_name== "None"|
z$bl_cul_isolate_name=="none"]<-"Negative"
z$bl.positive[is.na(z$bl.positive )]<-"Positive"
# Chunk 104: NP_swab_inclusion_exclusion
z$x1 <-NA
z$x1[z$np_done.factor=="No"]<-"Included: No NP"
z$x1[z$np_done.factor=="Yes"]<-"Excluded: NP Done"
z$x1<-factor(z$x1)
z$x2<-NA
z$x2[z$virus_on_np___12.factor=="Checked"]<-"Included: V-"
z$x2[z$virus_on_np___12.factor=="Unchecked"]<-"Excluded: V+"
z$x2<-factor(z$x2)
z$include <-NA
z$include[z$np_done.factor=="No"|z$virus_on_np___12.factor=="Checked"]<-"Include"
z$include[is.na(z$include)]<-"Exclude"
z$include<-factor(z$include)
# Chunk 105: recode effusion size
z$size.small    <-ifelse(z$size_effusion.factor=="Small" | z$size_effusion2_1aa.factor=="Small", "Yes","No")
z$size.moderate <-ifelse(z$size_effusion.factor=="Moderate" | z$size_effusion2_1aa.factor=="Moderate", "Yes","No")
z$size.large    <-ifelse(z$size_effusion.factor=="Large" | z$size_effusion2_1aa.factor=="Large", "Yes","No")
z$size.mod.large <-ifelse(z$size.moderate =="Yes"| z$size.large=="Yes", "Yes", "No" )
z$size.mod.large[is.na(z$size.mod.large )]<-"No"
z$size.unknown <-ifelse(z$size_effusion.factor=="Not available/Not applicable"& z$size_effusion2_1aa.factor=="Not available/Not applicable", "Yes", "No" )
z$size.small    <-factor(z$size.small)
z$size.moderate <-factor(z$size.moderate)
z$size.large    <-factor(z$size.large)
z$size.unknown  <-factor(z$size.unknown)
z$size.mod.large <-factor(z$size.mod.large )
# Chunk 106
z$group <-NA
z$group[z$virus_on_np___12.factor=="Unchecked" & z$np_done.factor=="Yes"]<-"NP Done: Virus+"
z$group[z$virus_on_np___12.factor=="Checked" & z$np_done.factor=="Yes"]<-"NP Done: Virus-"
z$group[z$np_done.factor=="No"] <-"NP Not Done"
z$group <-factor(z$group)
# Chunk 107: recode pleural isolates
z$gr_fl_cult_name_of_isolate.r <-z$gr_fl_cult_name_of_isolate
z$gr_fl_cult_name_of_isolate.r[z$gr_fl_cult_name_of_isolate=="GAS"]<-"Group A Strep"
z$gr_fl_cult_name_of_isolate.r[z$gr_fl_cult_name_of_isolate=="H. Beta-hemollytic Strep Group A"]<-"Group A Strep"
z$gr_fl_cult_name_of_isolate.r <-factor(z$gr_fl_cult_name_of_isolate.r)
# Chunk 108
z$gr_fl_cult_name_of_isolate <-factor(z$gr_fl_cult_name_of_isolate)
# Chunk 109: NP virus positive
z$virus.positive <-ifelse(z$virus_on_np___3==1 |
z$virus_on_np___4==1 |
z$virus_on_np___5==1 |
z$virus_on_np___6==1 |
z$virus_on_np___7==1 |
z$virus_on_np___8==1 |
z$virus_on_np___9==1 |
z$virus_on_np___10==1 |
z$virus_on_np___11==1, 1, 0)
z$virus.positive.factor <-NA
z$virus.positive.factor[z$virus.positive==1]<-"Yes"
z$virus.positive.factor[z$virus.positive==0]<-"No"
z$virus.positive.factor <-factor(z$virus.positive.factor)
z$virus.NP.other <-ifelse(z$npotherviruspresent!="", 1,0)
z$NP.virus.positive <-ifelse(z$virus.positive==1| z$npotherviruspresent!="", 1,0)
# Chunk 110: recode blood culture isolates
z$blood.culture.r <-NA
z$blood.culture.r[z$bl_cul_isolate_name=="Negative"|
z$bl_cul_isolate_name=="None"|
z$bl_cul_isolate_name=="negative"|
z$bl_cul_isolate_name=="none" |
z$bl_cul_isolate_name=="Acinotobacter species" |
z$bl_cul_isolate_name=="Bacillus species" |
z$bl_cul_isolate_name=="gram positive bacilli"|
z$bl_cul_isolate_name=="Paenibacillus" |
z$bl_cul_isolate_name== "Gram + Bacilli" |
z$bl_cul_isolate_name=="Staphylococcus epidermidis"] <-"Negative"
z$blood.culture.r[z$bl_cul_isolate_name== "alpha- haemolytic streptococcus"|
z$bl_cul_isolate_name== "Alpha-haemolytic streptococcus"] <-""
z$blood.culture.r[z$bl_cul_isolate_name== "S. Pneu"  |
z$bl_cul_isolate_name=="Streptococcus pneumoniae"  |
z$bl_cul_isolate_name=="strep pneumonaie" |
z$bl_cul_isolate_name=="Strep pneumonaie"|
z$bl_cul_isolate_name== "strep pneumonia"] <-"Strep pneumonaie"
z$blood.culture.r[z$bl_cul_isolate_name== "Coagulase negative staphylococcus"] <-""
z$blood.culture.r[z$bl_cul_isolate_name=="HI"] <-""
z$blood.culture.r[z$bl_cul_isolate_name=="Staph aureus"]<-"Staph aureus"
z$blood.culture.r[z$bl_cul_isolate_name=="Streptococcus angionosus, Coryneform bacteria" ]<-"Streptococcus angionosus"
z$blood.culture.r <-factor(z$blood.culture.r )
# Chunk 111
z$blood.culture.r.d <-ifelse(z$blood.culture.r=="Negative" | z$blood.culture.r=="", "Negative", "Positive")
z$blood.culture.r.d[is.na(z$blood.culture.r.d)]<-"Negative"
# Chunk 112
lobes.count<-select(z,
sites_of_infil_or_conso___0,
sites_fucxr___0,
sites_of_infil_or_conso___1,
sites_fucxr___1,
sites_of_infil_or_conso___2,
sites_fucxr___2,
sites_of_infil_or_conso___3,
sites_fucxr___3,
sites_of_infil_or_conso___4,
sites_fucxr___4,
sites_of_infil_or_conso___5,
sites_fucxr___5,
sites_of_infil_or_conso___6,
sites_fucxr___6,
sites_of_infil_or_conso___7,
sites_fucxr___7)
# Chunk 113
z$lobes.count <-rowSums(lobes.count, na.rm=T)
# Chunk 114
z$lobes.count.factor <-NA
z$lobes.count.factor[z$lobes.count==0]<-"Not available"
z$lobes.count.factor[z$lobes.count==1]<-"1"
z$lobes.count.factor[z$lobes.count==2]<-"2"
z$lobes.count.factor[z$lobes.count>2]<-"3+"
z$lobes.count.factor<-factor(z$lobes.count.factor)
# Chunk 115
z$effusions.all <-ifelse(z$chest_ct_findings___4==1 | z$eff_on_chest_u_s==1 | z$effusion==1, 1, 0)
z$effusions.all[is.na(z$effusions.all)]<-0
# Chunk 116
z$temp.over38 <-ifelse(z$temp>38.0, 1,0)
# Chunk 117: groups for abx comparison
z$DOT.AAP.3       <-ifelse(z$DOT.Amox.Ampic.Penicil.ALL>=3, 1,0)
z$DOT.AZYCLAR.3   <-ifelse(z$DOT.Azythro.Clarithro.ALL>3, 1,0)
z$DOT.CEPHALO.3   <-ifelse(z$DOT.cephalosporin.ALL>3, 1,0)
z$DOT.AAP.3.factor        <-factor(z$DOT.AAP.3,     labels=c("No", "Yes"))
z$DOT.AZYCLAR.3.factor    <-factor(z$DOT.AZYCLAR.3, labels=c("No", "Yes"))
z$DOT.CEPHALO.3.factor    <-factor(z$DOT.CEPHALO.3, labels=c("No", "Yes"))
# Chunk 118
#check to see if there are cases in which patients recieved greater than 3 DOT in more than 1 category
z$DOT.overlap.r <-z$DOT.AAP.3+z$DOT.CEPHALO.3 +z$DOT.AZYCLAR.3
# Chunk 119
z$o2.less.eq.92 <-ifelse(z$o2<=92, 1,0)
# Chunk 120: age exclusion
z$age.exclude <-ifelse(z$age.weeks.ed <8.0, 1,0)
# Chunk 121
age.under.8weeks <-select(z, study_id, age.weeks.ed) %>% filter(age.weeks.ed<8.0)
# Chunk 122: ageex
age.df <-select(z, study_id, age.weeks.ed, age.exclude) %>%
filter(age.exclude==1)
# dput(age.df$study_id)
z.id.x$sample[z.id.x$study_id  %in%  c("3", "70", "94", "105", "151", "349", "354", "369", "379", "423", "437", "2014-001", "2014-020", "2014-031", "2014-057",
"2014-058", "2014-091", "2014-092", "2014-094", "2014-096", "2014-130",
"2014-144", "2014-157", "2014-172", "2014-175", "2014-183", "2015-008",
"2015-014", "2015-023", "2015-032", "2015-033", "2015-049", "2015-053",
"2015-077", "2015-082", "2015-087", "2015-152", "2015-178", "2015-200",
"2015-207", "2015-208", "2016-020", "2016-045", "2016-049", "2016-081",
"2016-083", "2016-102", "2016-118", "2016-154")]<-"Exclude:under 8 weeks"
# Chunk 123
year.df <-select(z, study_id, year) %>% filter (year=="2011")
# dput(year.df$study_id)
z.id.x$sample[z.id.x$study_id  %in%  c("1", "2", "34", "169")]<-"Excluded from time analyses (2011)"
# Chunk 124: remove infants under 8 weeks
w <-z %>% filter(age.weeks.ed>=8.0)
# Chunk 126
h1 <- vtree(z,"age.exclude group", labelnode=list(age.exclude=(c("Over 8 weeks"="0","Under 8 weeks"="1"))), prune=list("age.exclude"=("1")),horiz=FALSE,showlevels=FALSE)
# Chunk 127
grVizToPNG(h1,folder="flowcharts")
# Chunk 128: dataframe for time analysis
#remove the 4 cases before 2021
zz <-w %>% filter(!year=="2011")
zz$year <-droplevels(zz$year)
library(haven)
#Write to SPSS as requested October 4, 2018
write_sav(zz, "CAPn715.sav")
setwd("R:/CRU Epibiostat/projects/Mary-Ann/20180038_Le Saux-Community_Acquired Pneumonia in Children Admitted to Hospital[.svn]/Analysis")
library(haven)
#Write to SPSS as requested October 4, 2018
write_sav(zz, "CAPn715.sav")
#Write to SPSS as requested October 4, 2018
write.csv(zz, file = "R:\\CRU Epibiostat\\projects\\Mary-Ann\\20180038_Le Saux-Community_Acquired Pneumonia in Children Admitted to Hospital[.svn]\\Analysis\\CAPn715.csv",  row.names = FALSE, na = "NA")
# write_sav(zz, "CAPn715.sav")
"
# Header
Some stuff
# Another header
Some more stuff
"
cat("
# Header
Some stuff
# Another header
Some more stuff
")
setwd("R:/CRU Epibiostat/projects/Mary-Ann/SAP")
setwd("R:/CRU Epibiostat/projects/Mary-Ann/20180038_Le Saux-Community_Acquired Pneumonia in Children Admitted to Hospital[.svn]/Analysis")
# Chunk 1
# a)      Want to see what antimicrobials did the patients with effusions get versus the uncomplicated? Not sure best way to look at this but perhaps by year?
#
# a.       2012 – ave # days of cephalosporins, ave # days of amp/pen or amox  then by year – my hypothesis is that as of late 2014, we started asp so there should be more on amp/pen/amox
#
# b)      Did children with NP swab positive versus NP swab negative get less antibiotics over the years?  My hypothesis is that we asked them (after 2015) to use only 5 days ….. if virus positive.
#
# c)       Finally what is the distribution of ages in pts who were virus positive vs virus negative vs No NP swab? – the virus positive ones should be younger…
# Chunk 2
f.eff <-fisher.test(table(zz.effusion$size.mod.large, zz$year))
zz$drainage.factor
# median/mean for los amox 4 A
#4B Cefu use over time & cefxiamine
#drainage
# Chunk 3: setup
knitr::opts_chunk$set(echo=FALSE,comment="##",fig.width=9.5,fig.height=6.5,dpi=2*72, warning=FALSE, message=FALSE)
# Chunk 4
library(Hmisc)
#library(descr)
library(tidyr)
library(dplyr)
library(forcats)
library(CRUmarkdown)
library(CRUmisc)
library(vtree)
library(lubridate)
library(foreign)
library(incidence)
library(ggplot2)
library(ggpubr)
library(broom)
library(scales)
# Chunk 5
#
# Read Data from an R workspace and then clean up.
#
env <- attach(params$datafileNew)
dataNew <- get("data",envir=env)
originalNew <- dataNew
detach(paste("file:",params$datafileNew,sep=""),character.only=TRUE)
# Chunk 6
#
# Read Data from an R workspace and then clean up.
#
env <- attach(params$datafileOld)
dataOld <- get("data",envir=env)
originalOld <- dataOld
detach(paste("file:",params$datafileOld,sep=""),character.only=TRUE)
# Chunk 7
npct <- hijack(npct, showN = TRUE,
shown = TRUE, showp = TRUE, nmiss = TRUE, nmiss0 = FALSE)
# Chunk 8
meanSDr <-hijack(meanSD, range =TRUE)
# Chunk 9: remove columns that are discordant
#
#1: remove columns that do not have equivalents between databases
#
z.old <-select(dataOld, -(mrn), -(eligible),-(eligible.factor), -(sibling_unknown ))
z.n<-select(dataNew, -(siblings.factor), -(initial_score.factor), -(final_score.factor))
# Chunk 10: rename variables
#
# 2. Rename variables to match-will rename new to match the original so I can do some quality control with old results
#
z.n <-select(z.n,
of_days_with_ili=days_illness,
days_with_temp_38_c	=days_temp_38	,
of_days_had_o_2=days_supp_02,
icu_admission_yes_or_no=icu_adm,
icu_date=icu_adm_dt,
icu_d_c_date=icu_dc_dt,
ventilation_yes_or_no=icu_vent,
start_date_to_ventilation=icu_vent_start_dt,
start_date_to_ventila2_b21=icu_vent_end_dt,
typedrainage=type_drainage,
dateofprocedure=procedure_dt,
dateofremoval=removal_dt,
bronchoscopy_done=bronchoscopy,
date_of_proc_for_broncho=	bronchoscopy_dt,
bronco_culture_result2_1a9=bronco_culture_pos,
yes_or_no_to_amoxil=amoxil,
yes_or_no_to_ampi=ampicillin,
yes_or_no_penicilln=penicillin,
yes_or_no_to_cephazolin=cephazolin,
yes_or_no_for_cefuroxime=	cefuroxime,
start_date_for_ceftri=start_date_ceftri,
stop_date_ceftri=stop_date_ceftri,
yes_or_no_to_clavulin	=clavulin	,
yes_or_no_cloxacillin=cloxacillin,
yes_or_no_clarithro	=clarithro,
yes_or_no_vancomycin=	vancomycin,
yes_or_no_clindamycin=clindamycin,
yes_or_no_azithromycin=azithromycin,
yes_or_no_doxycycline	=	doxycycline,
yes_or_no_piperracillin	=piperracillin,
yes_or_no_meropenem=meropenem,
yes_or_no_ceftaziime=ceftaziime,
yes_or_no_gentamycin=gentamycin,
yes_or_no_tobramycin=	tobramycin,
yes_or_no_metronidazole=metronidazole,
yes_or_no_oseltamivir=oseltamivir,
ampicillin_at_discharge=dc_ampicillin,
po_or_iv_ampicillin_at_dc=ampicillin_dc_route,
days_ampi_at_d_c=ampicillin_dc_days,
amox_clavu_acid_yes_or_no=dc_amox_clavu,
amox_clav_acid_po_or_iv	=dc_amox_clavu_route,
days_of_amox_c_a_at_d_c=dc_amox_clavu_days,
cefu_axetil_at_d_c=	dc_cefu_axetil,
cefu_axetil_po_or_iv=	dc_cefu_axetil_route,
days_cefur_axetil_at_d_c=dc_cefu_axetil_days,
azy_at_d_c_yes_or_no=dc_azythromycin,
azy_po_or_iv_at_d_c	=dc_azythromycin_route,
days_azythro_discharge=dc_azythromycin_days,
clarithro_at_d_c_yes_or_no=	dc_clarithro,
clarithro_po_or_iv=	dc_clarithro_route,
days_of_clarithro_at_d_c=dc_clarithro_days,
cefixime_at_d_c	=dc_cefixime,
cefixime_po_or_iv_at_d_c=dc_cefixime_route,
days_cefi_at_d_c=dc_cefixime_days,
septra_at_d_c	=dc_septra,
septra_po_or_iv_at_d_c=	dc_septra_route,
days_of_septra_at_d_c	=	dc_septra_days,
cloxacillin_at_d_c=dc_cloxacillin,
cloxa_po_or_iv_at_d_c	=	dc_cloxacillin_route,
days_of_cloxa_at_d_c=dc_cloxacillin_days,
other_abx_at_d_c=dc_other,
name_of_other_abx_at_d_c=	dc_other_name,
other_abx_po_or_iv_at_d_c=dc_other_route,
days_of_other_abx_at_d_c=dc_other_days,
follow_up_at_discahrge___1=fu_dc___1,
follow_up_at_discahrge___2=fu_dc___2,
follow_up_at_discahrge___3=fu_dc___3,
follow_up_at_discahrge___4=	fu_dc___4,
follow_up_at_discahrge___5=	fu_dc___5,
follow_up_at_discahrge___6=fu_dc___6,
death_yes_or_no=death,
icu_admission_yes_or_no.factor=icu_adm.factor,
ventilation_yes_or_no.factor=icu_vent.factor,
typedrainage.factor	=type_drainage.factor,
bronchoscopy_done.factor=bronchoscopy.factor,
yes_or_no_to_amoxil.factor=amoxil.factor,
yes_or_no_to_ampi.factor=	ampicillin.factor,
yes_or_no_penicilln.factor=penicillin.factor,
yes_or_no_to_cephazolin.factor=cephazolin.factor,
yes_or_no_for_cefuroxime.factor	=cefuroxime.factor,
yes_or_no_to_clavulin.factor=	clavulin.factor,
yes_or_no_cloxacillin.factor=cloxacillin.factor,
yes_or_no_clarithro.factor=clarithro.factor,
yes_or_no_vancomycin.factor=vancomycin.factor,
yes_or_no_clindamycin.factor=	clindamycin.factor,
yes_or_no_azithromycin.factor=azithromycin.factor,
yes_or_no_doxycycline.factor=doxycycline.factor,
yes_or_no_piperracillin.factor=piperracillin.factor,
yes_or_no_meropenem.factor=meropenem.factor,
yes_or_no_ceftaziime.factor=ceftaziime.factor,
yes_or_no_gentamycin.factor	=gentamycin.factor,
yes_or_no_tobramycin.factor=tobramycin.factor,
yes_or_no_metronidazole.factor=	metronidazole.factor,
yes_or_no_oseltamivir.factor=oseltamivir.factor,
ampicillin_at_discharge.factor=dc_ampicillin.factor,
po_or_iv_ampicillin_at_dc.factor=ampicillin_dc_route.factor,
amox_clavu_acid_yes_or_no.factor=dc_amox_clavu.factor,
amox_clav_acid_po_or_iv.factor=dc_amox_clavu_route.factor,
cefu_axetil_at_d_c.factor=dc_cefu_axetil.factor,
cefu_axetil_po_or_iv.factor=dc_cefu_axetil_route.factor,
azy_at_d_c_yes_or_no.factor=dc_azythromycin.factor,
azy_po_or_iv_at_d_c.factor=dc_azythromycin_route.factor,
clarithro_at_d_c_yes_or_no.factor=dc_clarithro.factor,
clarithro_po_or_iv.factor	=dc_clarithro_route.factor,
cefixime_at_d_c.factor=	dc_cefixime.factor,
cefixime_po_or_iv_at_d_c.factor=dc_cefixime_route.factor,
septra_at_d_c.factor=dc_septra.factor,
septra_po_or_iv_at_d_c.factor	=	dc_septra_route.factor,
cloxacillin_at_d_c.factor=dc_cloxacillin.factor	,
cloxa_po_or_iv_at_d_c.factor=dc_cloxacillin_route.factor,
other_abx_at_d_c.factor	=dc_other.factor,
other_abx_po_or_iv_at_d_c.factor=dc_other_route.factor,
follow_up_at_discahrge___1.factor=fu_dc___1.factor,
follow_up_at_discahrge___2.factor=fu_dc___2.factor,
follow_up_at_discahrge___3.factor=fu_dc___3.factor,
follow_up_at_discahrge___4.factor=fu_dc___4.factor,
follow_up_at_discahrge___5.factor=fu_dc___5.factor,
follow_up_at_discahrge___6.factor=fu_dc___6.factor,
death_yes_or_no.factor=death.factor, everything())
# Chunk 11: make variables compatible
#
# 3. Use setdiff to check variable compatibility before merging
#
# Error in setdiff_data_frame(x, y) : not compatible:
# - Incompatible type for column `study_id`: x labelled/factor, y integer
# - Incompatible type for column `gaweeks`: x integer, y labelled/factor
# - Incompatible type for column `initial_score`: x integer, y labelled/factor
# - Incompatible type for column `final_score`: x integer, y labelled/factor
# - Incompatible type for column `gram_stain_result`: x labelled/factor, y logical
# - Incompatible type for column `bronco_culture_result2_1a9`: x labelled/factor, y logical
# - Incompatible type for column `start_date_piperracillin`: x labelled/factor, y logical
# - Incompatible type for column `stop_date_piperracillin`: x labelled/factor, y logical
# - Incompatible type for column `start_date_tobramycin`: x labelled/factor, y logical
# - Incompatible type for column `stop_date_tobramycin`: x labelled/factor, y logical
# - Incompatible type for column `start_date_metronidazole`: x labelled/factor, y logical
# - Incompatible type for column `stop_date_metronidazole`: x labelled/factor
z.old$study_id <-factor(z.old$study_id)
z.old$gaweeks <-as.integer(z.old$gaweeks)
z.n$initial_score <-factor(z.n$initial_score)
z.n$final_score <-factor(z.n$final_score)
z.old$gram_stain_result<-as.factor(z.old$gram_stain_result)#All NA in DataOld
z.old$bronco_culture_result2_1a9 <-as.factor(z.old$bronco_culture_result2_1a9)#All NA in DataOld
z.old$start_date_piperracillin<-as.factor( z.old$start_date_piperracillin)#All NA  in DataOld
z.old$stop_date_piperracillin <-as.factor( z.old$stop_date_piperracillin)#All NA  in DataOld
z.old$start_date_tobramycin <-as.factor(z.old$start_date_tobramycin )#All NA  in DataOld
z.old$stop_date_tobramycin <-as.factor(z.old$stop_date_tobramycin)#All NA in DataOld
z.old$start_date_metronidazole <-as.factor(z.old$start_date_metronidazole)#All NA  in DataOld
z.old$stop_date_metronidazole <-as.factor(z.old$stop_date_metronidazole)#All NA  in DataOld
# Error in setdiff_data_frame(x, y) : not compatible:
# - Incompatible type for column `azy_po_or_iv_at_d_c`: x integer, y logical
# - Incompatible type for column `days_azythro_discharge`: x integer, y logical
# - Incompatible type for column `septra_po_or_iv_at_d_c`: x integer, y logical
# - Incompatible type for column `days_of_septra_at_d_c`: x integer, y logical
# - Incompatible type for column `death_related_to_pneumonia`: x integer, y logical
z.old$azy_po_or_iv_at_d_c <-as.integer(z.old$azy_po_or_iv_at_d_c)#All NA  in DataOld)#All blank in DataOld
z.old$days_azythro_discharge <-as.integer(z.old$days_azythro_discharge)#All NA  in DataOld
z.old$septra_po_or_iv_at_d_c <-as.integer(z.old$septra_po_or_iv_at_d_c)#All NA  in DataOld
z.old$days_of_septra_at_d_c <-as.integer(z.old$days_of_septra_at_d_c)#All NA  in DataOld
z.old$death_related_to_pneumonia <-as.integer(z.old$death_related_to_pneumonia)#All NA  in DataOld
z.old$rr <-as.numeric(z.old$rr)
# Chunk 12: merge
#
# merge
#
z <-bind_rows( z.old, z.n, .id="DF")
# Chunk 13
z.id.x <-z
# Chunk 14
a2015100 <-select(z, study_id, death_yes_or_no.factor) %>% filter(death_yes_or_no.factor=="Yes")
# Chunk 15
z.id.x$sample <-NA
z.id.x $sample[z.id.x$study_id=="2015-100"]<-"Exclude:died"
z<-z %>% filter(!study_id=="2015-100")
# Chunk 16
z<-z %>% filter(!study_id=="2016-009") %>%
filter(!study_id=="2015-09") %>%
filter(!study_id=="2015-090") %>%
filter(!study_id=="2015-119") %>%
filter(!study_id=="2015-124") %>%
filter(!study_id=="2015-069") %>%
filter(!study_id=="2016-094")
z.id.x$sample[z.id.x$study_id=="2016-009"|
z.id.x$study_id=="2015-09"|
z.id.x$study_id=="2015-090"|
z.id.x$study_id=="2015-119"|
z.id.x$study_id=="2015-124"|
z.id.x$study_id=="2015-069"|
z.id.x$study_id=="2016-094"]<-"Excluded"
# Chunk 17
#
# label the original data sets
#
z$DF[z$DF==1]<-"2012-13"
z$DF[z$DF==2]<-"2014-16"
z$DF<-factor(z$DF)
# Chunk 18
#
#Relabel factor with small case yes/no
z$effusion.factor<-fct_recode(z$effusion.factor, Yes = "yes", No = "no")
# Chunk 19
z$dob<-ymd(z$dob)
z$date_ed <-ymd(z$date_ed)
z$age.days.ed <-z$date_ed-z$dob
# Chunk 20
z$study.year <-year(z$date_ed)
z$study.year <-as.factor(z$study.year)
# Chunk 21
z$age.admit.days <-difftime(z$date_ed, z$dob, units="days")
z$age.admit.days <-as.numeric(z$age.admit.days )
z$age.admit.days <-round(z$age.admit.days, digits=1)
# Chunk 22
z$admit.years <-z$age.admit.days/365.4025
z$admit.years <-round(z$admit.years, digits=1)
# Chunk 23
z$age.weeks.ed <-difftime(z$date_ed, z$dob, units="weeks")
z$age.weeks.ed <-as.numeric(z$age.weeks.ed )
z$age.weeks.ed <-round(z$age.weeks.ed, digits=1)
# Chunk 24
z$age.months <-z$admit.years /12
z$age.months <-round(z$age.months, digits=2)
# z$age.negative <-ifelse(z$age.days<=0, 1,0)
# Chunk 25
z$date_dc <-ymd(z$date_dc)
z$los <-z$date_dc-z$date_ed
z$los<-as.numeric(z$los)
z$los<-round(z$los, digits=1)
# z$los.neg<-ifelse(z$los<=0, 1,0)
# Chunk 26: yearofstudy
z<-z %>%  mutate(year = substr(date_ed,  1, 4))
z$year <-factor(z$year)
# Chunk 27
z$date.month <-month(z$date_ed)
z$date.factor<-NA
z$date.factor[z$date.month==1|z$date.month==2|z$date.month==3]<-"Jan-Mar"
z$date.factor[z$date.month==4|z$date.month==5|z$date.month==6]<-"Apr-Jun"
z$date.factor[z$date.month==7|z$date.month==8|z$date.month==9]<-"Jul-Sep"
z$date.factor[z$date.month==10|z$date.month==11|z$date.month==12]<-"Oct-Dec"
z$date.factor<-factor(z$date.factor)
z$date.factor.oct_march <-NA
z$date.factor.oct_march[z$date.factor=="Oct-Dec"|z$date.factor=="Jan-Mar"]<-"Oct-Mar"
z$date.factor.oct_march[z$date.factor=="Apr-Jun"|z$date.factor=="Jul-Sep"]<-"Apr-Sept"
z$date.factor.oct_march <-factor( z$date.factor.oct_march)
install.packages("rrtools")
install.packages("devtools")
devtools::install_github("benmarwick/rrtools")
setwd("R:/CRU Epibiostat/projects/Mary-Ann/SAP")
install.packages("rrrpkg")
library(devtools)
assignInNamespace("version_info", c(devtools:::version_info, list("3.5" = list(version_min = "3.3.0", version_max = "99.99.99", path = "bin"))), "devtools")
install.packages("rrrpkg")
install.packages("rrtools")
